<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apps Script Connection Diagnostics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0f1419;
            color: #e6edf3;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
        }

        .deployment-info {
            background: #1c2128;
            border: 1px solid #373e47;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .deployment-info h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #58a6ff;
        }

        .url-display {
            background: #0d1117;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            word-break: break-all;
            color: #7ee787;
            border: 1px solid #30363d;
        }

        .action-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #21262d;
            color: #e6edf3;
            border: 1px solid #373e47;
        }

        .btn-secondary:hover {
            background: #30363d;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .test-section {
            background: #1c2128;
            border: 1px solid #373e47;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .test-header {
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            border-bottom: 1px solid #373e47;
        }

        .test-header:hover {
            background: #21262d;
        }

        .test-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 600;
        }

        .test-status {
            font-size: 24px;
        }

        .test-status.pending { color: #6e7681; }
        .test-status.running { 
            color: #f0883e;
            animation: pulse 1s infinite;
        }
        .test-status.success { color: #3fb950; }
        .test-status.error { color: #f85149; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .test-body {
            padding: 20px;
            display: none;
            background: #0d1117;
        }

        .test-body.expanded {
            display: block;
        }

        .test-info {
            margin-bottom: 15px;
        }

        .info-label {
            font-size: 12px;
            color: #7d8590;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .info-value {
            font-size: 14px;
            color: #e6edf3;
        }

        .code-block {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            color: #c9d1d9;
            margin: 10px 0;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.success {
            background: rgba(63, 185, 80, 0.15);
            color: #3fb950;
            border: 1px solid rgba(63, 185, 80, 0.3);
        }

        .status-badge.error {
            background: rgba(248, 81, 73, 0.15);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.3);
        }

        .status-badge.warning {
            background: rgba(240, 136, 62, 0.15);
            color: #f0883e;
            border: 1px solid rgba(240, 136, 62, 0.3);
        }

        .suggestions-section {
            background: #1c2128;
            border: 1px solid #373e47;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }

        .suggestions-section h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #58a6ff;
        }

        .suggestion-item {
            background: #0d1117;
            border-left: 4px solid #58a6ff;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
        }

        .suggestion-item h4 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #f0883e;
        }

        .suggestion-item p {
            font-size: 14px;
            color: #c9d1d9;
            line-height: 1.6;
        }

        .log-container {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-container h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #58a6ff;
            position: sticky;
            top: 0;
            background: #0d1117;
            padding-bottom: 10px;
        }

        .log-entry {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 13px;
            border-left: 3px solid;
        }

        .log-entry.info {
            background: rgba(88, 166, 255, 0.1);
            border-color: #58a6ff;
        }

        .log-entry.success {
            background: rgba(63, 185, 80, 0.1);
            border-color: #3fb950;
        }

        .log-entry.error {
            background: rgba(248, 81, 73, 0.1);
            border-color: #f85149;
        }

        .log-entry.warning {
            background: rgba(240, 136, 62, 0.1);
            border-color: #f0883e;
        }

        .log-time {
            color: #7d8590;
            font-size: 11px;
            margin-right: 10px;
        }

        .log-type {
            font-weight: 600;
            margin-right: 10px;
        }

        .log-message {
            color: #e6edf3;
        }

        .log-data {
            margin-top: 8px;
            padding: 10px;
            background: #161b22;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            color: #7ee787;
        }

        .summary-section {
            background: #1c2128;
            border: 1px solid #373e47;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            display: none;
        }

        .summary-section.visible {
            display: block;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .summary-card {
            background: #0d1117;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #30363d;
            text-align: center;
        }

        .summary-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 13px;
            color: #7d8590;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-bar {
            height: 4px;
            background: #30363d;
            border-radius: 2px;
            margin-top: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0;
            transition: width 0.3s ease;
        }

        .alternative-links {
            background: #1c2128;
            border: 1px solid #373e47;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }

        .alternative-links h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #58a6ff;
        }

        .link-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .link-item a {
            color: #58a6ff;
            text-decoration: none;
            flex: 1;
            word-break: break-all;
        }

        .link-item a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .action-bar {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Apps Script Connection Diagnostics</h1>
            <p>Comprehensive testing tool to identify connection issues</p>
        </div>

        <div class="deployment-info">
            <h3>üìç Deployment URL Being Tested</h3>
            <div class="url-display" id="deploymentUrl"></div>
        </div>

        <div class="action-bar">
            <button class="btn btn-primary" id="runAllTestsBtn">
                <span id="runBtnIcon">‚ñ∂Ô∏è</span>
                <span id="runBtnText">Run All Tests</span>
            </button>
            <button class="btn btn-secondary" id="copyResultsBtn">
                üìã Copy Results
            </button>
            <button class="btn btn-secondary" id="clearLogsBtn">
                üóëÔ∏è Clear Logs
            </button>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div id="testsContainer"></div>

        <div class="summary-section" id="summarySection">
            <h3>üìä Test Summary</h3>
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-value" id="totalTests">0</div>
                    <div class="summary-label">Total Tests</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" style="color: #3fb950;" id="passedTests">0</div>
                    <div class="summary-label">Passed</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" style="color: #f85149;" id="failedTests">0</div>
                    <div class="summary-label">Failed</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="totalTime">0s</div>
                    <div class="summary-label">Total Time</div>
                </div>
            </div>
        </div>

        <div class="suggestions-section" id="suggestionsSection" style="display: none;"></div>

        <div class="alternative-links">
            <h3>üîó Direct Browser Testing</h3>
            <div class="link-item">
                <span>üåê</span>
                <a href="https://script.google.com/macros/s/AKfycbz1YLGic1Q8ng6ofC62fP1O6J_x_JhWAmfQy2MLNv3MCo81n6D0RHN-eFLFgyVTGVLa/exec?action=healthCheck" target="_blank" rel="noopener">
                    Test Health Check in Browser
                </a>
            </div>
            <div class="link-item">
                <span>üìä</span>
                <a href="https://script.google.com/macros/s/AKfycbz1YLGic1Q8ng6ofC62fP1O6J_x_JhWAmfQy2MLNv3MCo81n6D0RHN-eFLFgyVTGVLa/exec?action=getStats" target="_blank" rel="noopener">
                    Test Get Stats in Browser
                </a>
            </div>
            <div class="link-item">
                <span>üìß</span>
                <a href="https://script.google.com/macros/s/AKfycbz1YLGic1Q8ng6ofC62fP1O6J_x_JhWAmfQy2MLNv3MCo81n6D0RHN-eFLFgyVTGVLa/exec?action=getEmails" target="_blank" rel="noopener">
                    Test Get Emails in Browser
                </a>
            </div>
        </div>

        <div class="log-container">
            <h3>üìù Console Log</h3>
            <div id="logContainer"></div>
        </div>
    </div>

    <script>
        // Configuration
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz1YLGic1Q8ng6ofC62fP1O6J_x_JhWAmfQy2MLNv3MCo81n6D0RHN-eFLFgyVTGVLa/exec';
        
        // State
        const state = {
            logs: [],
            testResults: [],
            startTime: null,
            suggestions: []
        };

        // Test definitions
        const tests = [
            {
                id: 'test1',
                name: 'Health Check (Standard GET)',
                description: 'Simple GET request to health check endpoint',
                endpoint: '?action=healthCheck',
                implementation: 'standard',
                method: 'GET'
            },
            {
                id: 'test2',
                name: 'Get Statistics',
                description: 'Fetch statistics data from Apps Script',
                endpoint: '?action=getStats',
                implementation: 'standard',
                method: 'GET'
            },
            {
                id: 'test3',
                name: 'Get Emails',
                description: 'Fetch email list from Apps Script',
                endpoint: '?action=getEmails',
                implementation: 'standard',
                method: 'GET'
            },
            {
                id: 'test4',
                name: 'No-CORS Mode Test',
                description: 'Attempt with no-cors mode (limited response access)',
                endpoint: '?action=healthCheck',
                implementation: 'no-cors',
                method: 'GET'
            },
            {
                id: 'test5',
                name: 'Minimal Fetch Test',
                description: 'Minimal fetch with no options',
                endpoint: '?action=healthCheck',
                implementation: 'minimal',
                method: 'GET'
            },
            {
                id: 'test6',
                name: 'Credentials Omit Test',
                description: 'Test with credentials explicitly omitted',
                endpoint: '?action=healthCheck',
                implementation: 'credentials-omit',
                method: 'GET'
            },
            {
                id: 'test7',
                name: 'XMLHttpRequest Test',
                description: 'Alternative method using XMLHttpRequest',
                endpoint: '?action=healthCheck',
                implementation: 'xhr',
                method: 'GET'
            }
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('deploymentUrl').textContent = APPS_SCRIPT_URL;
            initializeTests();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('runAllTestsBtn').addEventListener('click', runAllTests);
            document.getElementById('copyResultsBtn').addEventListener('click', copyResults);
            document.getElementById('clearLogsBtn').addEventListener('click', clearLogs);
        }

        // Initialize test UI
        function initializeTests() {
            const container = document.getElementById('testsContainer');
            container.innerHTML = tests.map(test => `
                <div class="test-section" id="${test.id}">
                    <div class="test-header" onclick="toggleTest('${test.id}')">
                        <div class="test-title">
                            <span class="test-status pending" id="${test.id}-status">‚è∏Ô∏è</span>
                            <span>${test.name}</span>
                        </div>
                        <span>‚ñº</span>
                    </div>
                    <div class="test-body" id="${test.id}-body">
                        <div class="test-info">
                            <div class="info-label">Description</div>
                            <div class="info-value">${test.description}</div>
                        </div>
                        <div class="test-info">
                            <div class="info-label">URL</div>
                            <div class="info-value">${APPS_SCRIPT_URL}${test.endpoint}</div>
                        </div>
                        <div class="test-info">
                            <div class="info-label">Method</div>
                            <div class="info-value">${test.method}</div>
                        </div>
                        <div class="test-info">
                            <div class="info-label">Implementation</div>
                            <div class="info-value">${test.implementation}</div>
                        </div>
                        <div id="${test.id}-results"></div>
                    </div>
                </div>
            `).join('');
        }

        // Toggle test visibility
        function toggleTest(testId) {
            const body = document.getElementById(`${testId}-body`);
            body.classList.toggle('expanded');
        }

        // Run all tests
        async function runAllTests() {
            const btn = document.getElementById('runAllTestsBtn');
            btn.disabled = true;
            
            // Reset state
            state.logs = [];
            state.testResults = [];
            state.suggestions = [];
            state.startTime = Date.now();
            
            clearLogs();
            document.getElementById('summarySection').classList.remove('visible');
            document.getElementById('suggestionsSection').style.display = 'none';
            document.getElementById('progressFill').style.width = '0%';
            
            log('info', 'Starting diagnostic tests...', { timestamp: new Date().toISOString() });
            
            // Run tests sequentially
            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                log('info', `Running: ${test.name}`);
                await runTest(test);
                
                // Update progress
                const progress = ((i + 1) / tests.length) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // Generate summary
            generateSummary();
            generateSuggestions();
            
            log('success', 'All tests completed!');
            btn.disabled = false;
        }

        // Run individual test
        async function runTest(test) {
            const statusEl = document.getElementById(`${test.id}-status`);
            const resultsEl = document.getElementById(`${test.id}-results`);
            
            // Set running state
            statusEl.textContent = '‚è≥';
            statusEl.className = 'test-status running';
            
            const startTime = Date.now();
            let result = {
                testId: test.id,
                testName: test.name,
                success: false,
                status: null,
                headers: {},
                body: null,
                error: null,
                timing: 0
            };
            
            try {
                const url = APPS_SCRIPT_URL + test.endpoint;
                
                // Execute based on implementation type
                let response;
                switch (test.implementation) {
                    case 'standard':
                        response = await fetch(url, {
                            method: 'GET',
                            redirect: 'follow',
                            mode: 'cors'
                        });
                        break;
                    
                    case 'no-cors':
                        response = await fetch(url, {
                            method: 'GET',
                            mode: 'no-cors'
                        });
                        break;
                    
                    case 'minimal':
                        response = await fetch(url);
                        break;
                    
                    case 'credentials-omit':
                        response = await fetch(url, {
                            method: 'GET',
                            credentials: 'omit',
                            redirect: 'follow'
                        });
                        break;
                    
                    case 'xhr':
                        response = await xhrRequest(url);
                        break;
                }
                
                result.timing = Date.now() - startTime;
                result.status = response.status;
                
                // Extract headers (if available)
                if (response.headers) {
                    response.headers.forEach((value, key) => {
                        result.headers[key] = value;
                    });
                }
                
                // Try to get response body
                if (test.implementation === 'no-cors') {
                    result.body = 'Response body not accessible in no-cors mode';
                    result.success = response.type === 'opaque';
                } else if (test.implementation === 'xhr') {
                    result.body = response.responseText;
                    result.success = response.status >= 200 && response.status < 300;
                } else {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        result.body = await response.json();
                    } else {
                        result.body = await response.text();
                    }
                    result.success = response.ok;
                }
                
                // Update UI
                statusEl.textContent = result.success ? '‚úÖ' : '‚ùå';
                statusEl.className = `test-status ${result.success ? 'success' : 'error'}`;
                
                resultsEl.innerHTML = `
                    <div class="test-info">
                        <div class="info-label">Status</div>
                        <div class="info-value">
                            <span class="status-badge ${result.success ? 'success' : 'error'}">
                                ${result.status || 'N/A'} ${result.success ? 'Success' : 'Failed'}
                            </span>
                        </div>
                    </div>
                    <div class="test-info">
                        <div class="info-label">Response Time</div>
                        <div class="info-value">${result.timing}ms</div>
                    </div>
                    ${Object.keys(result.headers).length > 0 ? `
                        <div class="test-info">
                            <div class="info-label">Response Headers</div>
                            <div class="code-block">${JSON.stringify(result.headers, null, 2)}</div>
                        </div>
                    ` : ''}
                    <div class="test-info">
                        <div class="info-label">Response Body</div>
                        <div class="code-block">${typeof result.body === 'object' ? JSON.stringify(result.body, null, 2) : result.body}</div>
                    </div>
                `;
                
                // Expand if failed
                if (!result.success) {
                    document.getElementById(`${test.id}-body`).classList.add('expanded');
                }
                
                log(result.success ? 'success' : 'error', 
                    `${test.name}: ${result.success ? 'PASSED' : 'FAILED'}`,
                    { status: result.status, timing: `${result.timing}ms` }
                );
                
            } catch (error) {
                result.timing = Date.now() - startTime;
                result.error = {
                    message: error.message,
                    type: error.name,
                    stack: error.stack
                };
                
                statusEl.textContent = '‚ùå';
                statusEl.className = 'test-status error';
                
                resultsEl.innerHTML = `
                    <div class="test-info">
                        <div class="info-label">Error Type</div>
                        <div class="info-value">
                            <span class="status-badge error">${error.name}</span>
                        </div>
                    </div>
                    <div class="test-info">
                        <div class="info-label">Error Message</div>
                        <div class="info-value">${error.message}</div>
                    </div>
                    <div class="test-info">
                        <div class="info-label">Stack Trace</div>
                        <div class="code-block">${error.stack || 'Not available'}</div>
                    </div>
                `;
                
                document.getElementById(`${test.id}-body`).classList.add('expanded');
                
                log('error', `${test.name}: ERROR - ${error.message}`, {
                    type: error.name,
                    message: error.message
                });
            }
            
            state.testResults.push(result);
        }

        // XMLHttpRequest implementation
        function xhrRequest(url) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', url, true);
                xhr.timeout = 10000;
                
                xhr.onload = function() {
                    resolve({
                        status: xhr.status,
                        responseText: xhr.responseText,
                        headers: {}
                    });
                };
                
                xhr.onerror = function() {
                    reject(new Error('XMLHttpRequest failed'));
                };
                
                xhr.ontimeout = function() {
                    reject(new Error('XMLHttpRequest timeout'));
                };
                
                xhr.send();
            });
        }

        // Generate summary
        function generateSummary() {
            const totalTests = state.testResults.length;
            const passedTests = state.testResults.filter(r => r.success).length;
            const failedTests = totalTests - passedTests;
            const totalTime = ((Date.now() - state.startTime) / 1000).toFixed(2);
            
            document.getElementById('totalTests').textContent = totalTests;
            document.getElementById('passedTests').textContent = passedTests;
            document.getElementById('failedTests').textContent = failedTests;
            document.getElementById('totalTime').textContent = `${totalTime}s`;
            
            document.getElementById('summarySection').classList.add('visible');
        }

        // Generate suggestions
        function generateSuggestions() {
            const suggestions = [];
            const errors = state.testResults.filter(r => !r.success);
            
            // Check for CORS errors
            const corsErrors = errors.filter(e => 
                e.error && (e.error.message.includes('CORS') || e.error.type === 'TypeError')
            );
            if (corsErrors.length > 0) {
                suggestions.push({
                    title: 'CORS Policy Error Detected',
                    description: 'The Apps Script is blocking cross-origin requests. You need to redeploy the script with correct CORS headers. Make sure "Who has access" is set to "Anyone" and the script is deployed as a web app.'
                });
            }
            
            // Check for 404 errors
            const notFoundErrors = errors.filter(e => e.status === 404);
            if (notFoundErrors.length > 0) {
                suggestions.push({
                    title: '404 Not Found',
                    description: 'The deployment URL appears to be incorrect or the script is not deployed. Verify the deployment ID and make sure the script is deployed as a web app.'
                });
            }
            
            // Check for 403 errors
            const forbiddenErrors = errors.filter(e => e.status === 403);
            if (forbiddenErrors.length > 0) {
                suggestions.push({
                    title: '403 Forbidden - Permission Denied',
                    description: 'The Apps Script "Who has access" setting must be set to "Anyone" (or "Anyone with the link"). Go to Deploy ‚Üí Manage deployments ‚Üí Edit ‚Üí Who has access.'
                });
            }
            
            // Check if all standard tests failed
            const standardTests = state.testResults.filter(r => r.testName.includes('Standard') || r.testName.includes('Statistics') || r.testName.includes('Emails'));
            if (standardTests.every(t => !t.success)) {
                suggestions.push({
                    title: 'All Standard Tests Failed',
                    description: 'None of the standard fetch requests succeeded. This typically indicates a deployment issue. Try: 1) Redeploy the script as a new version, 2) Check "Execute as: Me", 3) Set "Who has access: Anyone".'
                });
            }
            
            // Check for network errors
            const networkErrors = errors.filter(e => 
                e.error && (e.error.message.includes('network') || e.error.message.includes('Failed to fetch'))
            );
            if (networkErrors.length > 0) {
                suggestions.push({
                    title: 'Network Error',
                    description: 'Unable to reach the Apps Script URL. Check your internet connection and verify the deployment URL is correct.'
                });
            }
            
            // Display suggestions
            if (suggestions.length > 0) {
                const suggestionsSection = document.getElementById('suggestionsSection');
                suggestionsSection.style.display = 'block';
                suggestionsSection.innerHTML = `
                    <h3>üí° Suggested Fixes</h3>
                    ${suggestions.map(s => `
                        <div class="suggestion-item">
                            <h4>${s.title}</h4>
                            <p>${s.description}</p>
                        </div>
                    `).join('')}
                `;
            }
        }

        // Logging function
        function log(type, message, data = null) {
            const entry = {
                timestamp: new Date().toISOString(),
                type: type,
                message: message,
                data: data
            };
            
            state.logs.push(entry);
            displayLog(entry);
        }

        // Display log entry
        function displayLog(entry) {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${entry.type}`;
            
            const time = new Date(entry.timestamp).toLocaleTimeString();
            logEntry.innerHTML = `
                <span class="log-time">${time}</span>
                <span class="log-type">[${entry.type.toUpperCase()}]</span>
                <span class="log-message">${entry.message}</span>
                ${entry.data ? `<pre class="log-data">${JSON.stringify(entry.data, null, 2)}</pre>` : ''}
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Clear logs
        function clearLogs() {
            state.logs = [];
            document.getElementById('logContainer').innerHTML = '';
        }

        // Copy results to clipboard
        function copyResults() {
            const results = {
                timestamp: new Date().toISOString(),
                deploymentUrl: APPS_SCRIPT_URL,
                summary: {
                    totalTests: state.testResults.length,
                    passed: state.testResults.filter(r => r.success).length,
                    failed: state.testResults.filter(r => !r.success).length
                },
                tests: state.testResults,
                logs: state.logs
            };
            
            const text = JSON.stringify(results, null, 2);
            
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Results copied to clipboard!');
            }).catch(err => {
                alert('‚ùå Failed to copy: ' + err.message);
            });
        }
    </script>
</body>
</html>