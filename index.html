<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Auto-Response System Dashboard</title>
    <style>
        /* Design System Variables */
        :root {
            --primary-bg: #181A20;
            --secondary-bg: #23272F;
            --card-bg: #292D36;
            --text-primary: #FFFFFF;
            --text-secondary: #E4E6EB;
            --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --border-color: rgba(255, 255, 255, 0.1);
            --success-color: #43e97b;
            --warning-color: #f5576c;
            --info-color: #4facfe;
            --pricing-color: #667eea;
            --support-color: #f093fb;
            --general-color: #4facfe;
            --technical-color: #43e97b;
            --sales-color: #fa709a;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .dashboard-header {
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .dashboard-header h1 {
            font-size: 28px;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--card-bg);
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--success-color);
        }

        .status-dot.loading {
            background: #ffa500;
        }

        .status-dot.error {
            background: var(--warning-color);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-text {
            font-size: 14px;
            font-weight: 500;
        }

        .btn-refresh {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-refresh:hover {
            background: var(--secondary-bg);
            transform: rotate(180deg);
        }

        .btn-refresh:active {
            transform: rotate(180deg) scale(0.95);
        }

        .last-updated {
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.7;
        }

        /* Error Banner */
        .error-banner {
            background: rgba(245, 87, 108, 0.1);
            border: 1px solid rgba(245, 87, 108, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .error-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .error-icon {
            font-size: 24px;
        }

        .error-message {
            flex: 1;
        }

        .error-message strong {
            display: block;
            margin-bottom: 4px;
            color: var(--warning-color);
        }

        .error-message p {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0;
        }

        .btn-retry {
            background: var(--warning-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-retry:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        /* Statistics Section */
        .stats-section {
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .stat-icon svg {
            color: white;
        }

        .stat-content {
            flex: 1;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Email Feed Section */
        .email-feed-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .email-count {
            font-size: 14px;
            color: var(--text-secondary);
            padding: 6px 12px;
            background: var(--secondary-bg);
            border-radius: 20px;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-spinner p {
            margin-top: 16px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Email Feed */
        .email-feed {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .email-card {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .email-card:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.3);
            transform: translateX(4px);
        }

        .email-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .email-from {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 15px;
        }

        .email-time {
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .email-subject {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .email-preview {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .email-card-footer {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .badge {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge.pricing {
            background: rgba(102, 126, 234, 0.2);
            color: var(--pricing-color);
        }

        .badge.support {
            background: rgba(240, 147, 251, 0.2);
            color: var(--support-color);
        }

        .badge.general {
            background: rgba(79, 172, 254, 0.2);
            color: var(--general-color);
        }

        .badge.technical {
            background: rgba(67, 233, 123, 0.2);
            color: var(--technical-color);
        }

        .badge.sales {
            background: rgba(250, 112, 154, 0.2);
            color: var(--sales-color);
        }

        .status-badge {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 12px;
            background: rgba(67, 233, 123, 0.2);
            color: var(--success-color);
            font-weight: 600;
        }

        .response-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: auto;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border-radius: 6px;
        }

        .modal-close:hover {
            background: var(--secondary-bg);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .email-detail-section {
            margin-bottom: 20px;
        }

        .email-detail-section:last-child {
            margin-bottom: 0;
        }

        .email-detail-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .email-detail-value {
            font-size: 14px;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .email-detail-body {
            background: var(--secondary-bg);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .form-input,
        .form-textarea {
            width: 100%;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }

        /* Buttons */
        .btn-primary,
        .btn-secondary {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent-gradient);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--primary-bg);
        }

        .btn-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Toast Notification System */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            min-width: 300px;
            max-width: 400px;
            pointer-events: all;
            opacity: 0;
            transform: translateX(400px);
            transition: all 0.3s ease;
        }

        .toast.toast-show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-success {
            background: rgba(67, 233, 123, 0.15);
            border: 1px solid rgba(67, 233, 123, 0.4);
            color: var(--success-color);
        }

        .toast-error {
            background: rgba(245, 87, 108, 0.15);
            border: 1px solid rgba(245, 87, 108, 0.4);
            color: var(--warning-color);
        }

        .toast-icon {
            font-size: 20px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .toast-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state p {
            font-size: 14px;
            opacity: 0.7;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 15px;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                max-height: 90vh;
            }

            .email-card-header {
                flex-direction: column;
                gap: 8px;
            }

            .toast-container {
                left: 10px;
                right: 10px;
                top: 10px;
            }

            .toast {
                min-width: unset;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <h1>📧 Email Auto-Response System</h1>
                <div class="header-actions">
                    <div class="connection-status" id="connectionStatus">
                        <span class="status-dot" id="statusDot"></span>
                        <span class="status-text" id="statusText">Connecting...</span>
                    </div>
                    <button class="btn-refresh" id="refreshBtn" title="Refresh Data">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="last-updated" id="lastUpdated">Last updated: Never</div>
        </header>

        <!-- Error Banner -->
        <div class="error-banner" id="errorBanner" style="display: none;">
            <div class="error-content">
                <span class="error-icon">⚠️</span>
                <div class="error-message">
                    <strong>Connection Error</strong>
                    <p id="errorText">Unable to fetch data from the server.</p>
                </div>
                <button class="btn-retry" id="retryBtn">Retry</button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <section class="stats-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <polyline points="22,6 12,13 2,6"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Total Emails</div>
                        <div class="stat-value" id="totalEmails">--</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Auto-Responded</div>
                        <div class="stat-value" id="autoResponded">--</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Avg Response Time</div>
                        <div class="stat-value" id="avgResponseTime">--</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Success Rate</div>
                        <div class="stat-value" id="successRate">--</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Email Feed -->
        <section class="email-feed-section">
            <div class="section-header">
                <h2>Recent Emails</h2>
                <div class="email-count" id="emailCount">0 emails</div>
            </div>
            
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
                <p>Loading emails...</p>
            </div>

            <div class="email-feed" id="emailFeed">
                <!-- Email cards will be populated here -->
            </div>
        </section>
    </div>

    <!-- Email Detail Modal -->
    <div class="modal-overlay" id="modalOverlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Email Details</h3>
                <button class="modal-close" id="modalClose">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Email details will be populated here -->
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="modalCloseBtn">Close</button>
                <button class="btn-primary" id="sendFollowUpBtn">Send Follow-up</button>
            </div>
        </div>
    </div>

    <!-- Follow-up Email Modal -->
    <div class="modal-overlay" id="followUpModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Send Follow-up Email</h3>
                <button class="modal-close" id="followUpModalClose">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="followUpForm">
                    <div class="form-group">
                        <label for="followUpRecipient">To:</label>
                        <input type="email" id="followUpRecipient" class="form-input" readonly>
                    </div>
                    <div class="form-group">
                        <label for="followUpSubject">Subject:</label>
                        <input type="text" id="followUpSubject" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="followUpMessage">Message:</label>
                        <textarea id="followUpMessage" class="form-textarea" rows="8" required></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" id="cancelFollowUpBtn">Cancel</button>
                        <button type="submit" class="btn-primary" id="submitFollowUpBtn">
                            <span class="btn-text">Send Email</span>
                            <span class="btn-spinner" style="display: none;"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Configuration - DEFINED ONCE
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyD66_BK8koT_x2T3rS3idFTcyQ8rS3SiPyKEyP7pZUeP3ceZQKQdKhS7MXQzayqfc/exec';
        const AUTO_REFRESH_INTERVAL = 30000; // 30 seconds

        // State management - DEFINED ONCE
        let currentEmail = null;
        let autoRefreshTimer = null;
        let emailsData = [];

        // API Functions - EACH DEFINED ONCE
        async function fetchStats() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getStats`, {
                    method: 'GET',
                    redirect: 'follow',
                    mode: 'cors'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.success && data.stats) {
                    return data.stats;
                } else {
                    throw new Error('Invalid stats data format');
                }
            } catch (error) {
                console.error('Error fetching stats:', error);
                throw error;
            }
        }

        async function fetchEmails() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getEmails`, {
                    method: 'GET',
                    redirect: 'follow',
                    mode: 'cors'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.success && data.emails) {
                    return data.emails;
                } else {
                    throw new Error('Invalid emails data format');
                }
            } catch (error) {
                console.error('Error fetching emails:', error);
                throw error;
            }
        }

        async function sendFollowUpEmail(recipient, subject, message) {
            try {
                console.log('Preparing to send follow-up email to:', recipient);
                
                const formData = new URLSearchParams();
                formData.append('action', 'sendEmail');
                formData.append('recipient', recipient);
                formData.append('subject', subject);
                formData.append('message', message);

                console.log('POST request body:', formData.toString());

                // CRITICAL: No headers - let browser set Content-Type automatically
                // This avoids CORS preflight which Apps Script doesn't support
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData,
                    redirect: 'follow',
                    mode: 'cors'
                });

                console.log('Response status:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Try to get response text first
                const text = await response.text();
                console.log('Response text:', text.substring(0, 200));

                // Try to parse as JSON, but handle HTML responses
                let data;
                try {
                    data = JSON.parse(text);
                    console.log('Parsed JSON response:', data);
                } catch (e) {
                    console.warn('Response is not JSON, treating as success');
                    // If not JSON but status is 200, treat as success
                    if (response.status === 200) {
                        data = { success: true, message: 'Email sent' };
                    } else {
                        throw new Error('Invalid response format');
                    }
                }

                if (!data.success) {
                    throw new Error(data.error || data.message || 'Failed to send email');
                }

                return data;
            } catch (error) {
                console.error('Error sending follow-up email:', error);
                throw error;
            }
        }

        // UI Update Functions - EACH DEFINED ONCE
        function updateStatistics(stats) {
            document.getElementById('totalEmails').textContent = stats.totalEmails || 0;
            document.getElementById('autoResponded').textContent = stats.autoResponded || 0;
            document.getElementById('avgResponseTime').textContent = stats.avgResponseTime || '--';
            
            const total = stats.totalEmails || 0;
            const responded = stats.autoResponded || 0;
            const successRate = stats.successRate || (total > 0 ? Math.round((responded / total) * 100) : 0);
            document.getElementById('successRate').textContent = successRate + '%';
        }

        function displayEmails(emails) {
            const emailFeed = document.getElementById('emailFeed');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const emailCount = document.getElementById('emailCount');

            loadingSpinner.style.display = 'none';
            emailCount.textContent = `${emails.length} email${emails.length !== 1 ? 's' : ''}`;

            if (emails.length === 0) {
                emailFeed.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📭</div>
                        <h3>No emails yet</h3>
                        <p>Emails will appear here when they are received</p>
                    </div>
                `;
                return;
            }

            emailFeed.innerHTML = emails.map(email => {
                const inquiryTypeLower = (email.inquiryType || 'general').toLowerCase();
                const timeAgo = getRelativeTime(email.timestamp);
                const preview = email.body ? email.body.substring(0, 80) + '...' : 'No preview available';

                return `
                    <div class="email-card" data-email-index="${emails.indexOf(email)}">
                        <div class="email-card-header">
                            <div class="email-from">${escapeHtml(email.from)}</div>
                            <div class="email-time">${timeAgo}</div>
                        </div>
                        <div class="email-subject">${escapeHtml(email.subject)}</div>
                        <div class="email-preview">${escapeHtml(preview)}</div>
                        <div class="email-card-footer">
                            <span class="badge ${inquiryTypeLower}">${email.inquiryType || 'General'}</span>
                            ${email.status === 'Auto-Responded' ? '<span class="status-badge">✓ Auto-Responded</span>' : ''}
                            ${email.responseTime ? `<span class="response-time">⏱ ${email.responseTime}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            emailFeed.querySelectorAll('.email-card').forEach((card, index) => {
                card.addEventListener('click', () => openEmailModal(emails[index]));
            });
        }

        // Modal Functions - EACH DEFINED ONCE
        function openEmailModal(email) {
            currentEmail = email;
            const modalBody = document.getElementById('modalBody');
            const inquiryTypeLower = (email.inquiryType || 'general').toLowerCase();

            modalBody.innerHTML = `
                <div class="email-detail-section">
                    <div class="email-detail-label">From</div>
                    <div class="email-detail-value">${escapeHtml(email.from)}</div>
                </div>
                <div class="email-detail-section">
                    <div class="email-detail-label">Subject</div>
                    <div class="email-detail-value">${escapeHtml(email.subject)}</div>
                </div>
                <div class="email-detail-section">
                    <div class="email-detail-label">Received</div>
                    <div class="email-detail-value">${formatDateTime(email.timestamp)}</div>
                </div>
                <div class="email-detail-section">
                    <div class="email-detail-label">Inquiry Type</div>
                    <div class="email-detail-value">
                        <span class="badge ${inquiryTypeLower}">${email.inquiryType || 'General'}</span>
                    </div>
                </div>
                <div class="email-detail-section">
                    <div class="email-detail-label">Status</div>
                    <div class="email-detail-value">
                        ${email.status === 'Auto-Responded' ? '<span class="status-badge">✓ Auto-Responded</span>' : '<span>Pending</span>'}
                        ${email.responseTime ? ` in ${email.responseTime}` : ''}
                    </div>
                </div>
                <div class="email-detail-section">
                    <div class="email-detail-label">Message</div>
                    <div class="email-detail-value email-detail-body">${escapeHtml(email.body || 'No message content')}</div>
                </div>
                ${email.reply ? `
                <div class="email-detail-section">
                    <div class="email-detail-label">Auto-Response Sent</div>
                    <div class="email-detail-value email-detail-body">${escapeHtml(email.reply)}</div>
                </div>
                ` : ''}
            `;

            document.getElementById('modalOverlay').style.display = 'flex';
        }

        function closeEmailModal() {
            document.getElementById('modalOverlay').style.display = 'none';
            currentEmail = null;
        }

        function openFollowUpForm() {
            if (!currentEmail) return;

            document.getElementById('followUpRecipient').value = currentEmail.from;
            document.getElementById('followUpSubject').value = `Re: ${currentEmail.subject}`;
            document.getElementById('followUpMessage').value = '';

            closeEmailModal();
            document.getElementById('followUpModal').style.display = 'flex';
        }

        function closeFollowUpForm() {
            document.getElementById('followUpModal').style.display = 'none';
            document.getElementById('followUpForm').reset();
        }

        // Utility Functions - EACH DEFINED ONCE
        function showNotification(message, type) {
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container';
                document.body.appendChild(toastContainer);
            }

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icon = type === 'success' ? '✓' : '✕';
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${escapeHtml(message)}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;

            toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('toast-show'), 10);

            if (type === 'success') {
                setTimeout(() => {
                    toast.classList.remove('toast-show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        }

        function updateConnectionStatus(status, text) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            statusDot.className = `status-dot ${status}`;
            statusText.textContent = text;
        }

        function getRelativeTime(timestamp) {
            if (!timestamp) return 'Unknown time';

            const now = new Date();
            const emailDate = new Date(timestamp);
            const diffMs = now - emailDate;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min${diffMins !== 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;

            return emailDate.toLocaleDateString();
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            const errorBanner = document.getElementById('errorBanner');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorBanner.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorBanner').style.display = 'none';
        }

        function updateLastUpdated() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('lastUpdated').textContent = `Last updated: ${timeString}`;
        }

        // Event Handlers - EACH DEFINED ONCE
        async function handleFollowUpSubmit(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitFollowUpBtn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnSpinner = submitBtn.querySelector('.btn-spinner');

            // Validate fields
            const recipient = document.getElementById('followUpRecipient').value.trim();
            const subject = document.getElementById('followUpSubject').value.trim();
            const message = document.getElementById('followUpMessage').value.trim();

            if (!recipient || !subject || !message) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            try {
                console.log('=== SENDING FOLLOW-UP EMAIL ===');
                submitBtn.disabled = true;
                btnText.style.display = 'none';
                btnSpinner.style.display = 'block';
                btnText.textContent = 'Sending...';

                const result = await sendFollowUpEmail(recipient, subject, message);
                console.log('Email sent successfully:', result);
                
                showNotification('✓ Follow-up email sent successfully!', 'success');
                closeFollowUpForm();
            } catch (error) {
                console.error('=== ERROR SENDING EMAIL ===');
                console.error('Error details:', error);
                showNotification(`Failed to send email: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                btnText.style.display = 'block';
                btnSpinner.style.display = 'none';
                btnText.textContent = 'Send Email';
            }
        }

        async function loadData() {
            try {
                updateConnectionStatus('loading', 'Loading...');
                hideError();

                const [stats, emails] = await Promise.all([
                    fetchStats(),
                    fetchEmails()
                ]);

                if (stats) updateStatistics(stats);
                if (emails) {
                    emailsData = emails;
                    displayEmails(emails);
                }

                updateConnectionStatus('connected', 'Connected');
                updateLastUpdated();
            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                updateConnectionStatus('error', 'Disconnected');
                showError('Unable to fetch data from the server. Please check your connection and try again.');
            }
        }

        // Initialization - RUNS ONCE
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setInterval(loadData, AUTO_REFRESH_INTERVAL);

            // Event Listeners - ATTACHED ONCE
            document.getElementById('refreshBtn').addEventListener('click', loadData);
            document.getElementById('retryBtn').addEventListener('click', () => {
                hideError();
                loadData();
            });

            document.getElementById('modalClose').addEventListener('click', closeEmailModal);
            document.getElementById('modalCloseBtn').addEventListener('click', closeEmailModal);
            document.getElementById('modalOverlay').addEventListener('click', (e) => {
                if (e.target.id === 'modalOverlay') closeEmailModal();
            });

            document.getElementById('sendFollowUpBtn').addEventListener('click', openFollowUpForm);
            document.getElementById('followUpModalClose').addEventListener('click', closeFollowUpForm);
            document.getElementById('cancelFollowUpBtn').addEventListener('click', closeFollowUpForm);
            document.getElementById('followUpModal').addEventListener('click', (e) => {
                if (e.target.id === 'followUpModal') closeFollowUpForm();
            });

            document.getElementById('followUpForm').addEventListener('submit', handleFollowUpSubmit);
        });
    </script>
</body>
</html>